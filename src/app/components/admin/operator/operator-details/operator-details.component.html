<div class="h-100 w-100 overflow-y-auto bg-white p-4 px-5">
  <!-- loading -->

  @if (organizationDetailsLoading || loadingPermission) {
    <span
      class="w-100 h-100 d-flex justify-content-center align-items-center p-4">
      <i class="fa-solid fa-spin fa-circle-notch fa-3x text-dark"></i>
    </span>
  }

  <!-- Operator Badge -->
  @if (!organizationDetailsLoading && !loadingPermission) {
    @if (organizationDetails) {
      <div class="d-flex flex-row gap-4 p-2 px-3 mb-4">
        <div
          class="rounded-circle bg-secondary me-4 position-relative d-flex align-items-center justify-content-center"
          style="width: 104px; height: 104px">
          @if (organizationDetails.operator.employee_client?.picture) {
            <img
              class="image rounded-circle"
              src="{{ organizationDetails.operator.employee_client?.picture }}"
              alt="{{ organizationDetails.operator.username }} Logo" />
          }
          <!-- if no picture -->
          @if (
            !organizationDetails.operator.employee_client ||
            !organizationDetails.operator.employee_client.picture
          ) {
            <span class="text-secondary" style="font-size: 3rem">
              <i class="fa-solid fa-user-tie fa-xl"></i>
            </span>
          }
          <span
            class="text-secondary position-absolute fs-5 clickable rounded-circle bg-white"
            style="
              bottom: 0;
              right: -3%;
              z-index: 10;
              cursor: pointer;
              height: 30px;
              width: 30px;
            "
            title="Refresh"
            tabindex="0"
            (click)="refresh()">
            <i
              class="fa-solid fa-arrows-rotate text-secondary rounded-circle p-1"></i>
          </span>
        </div>
        <div class="d-flex flex-column text-dark justify-content-center gap-2">
          <b class="fs-large fw-bold">{{
            organizationDetails.operator.employee_client?.client_full_name ??
              '------'
          }}</b>
          <b>{{
            organizationDetails.operator.employee_client?.client_code ??
              '------'
          }}</b>
          <div class="d-flex flex-row gap-2">
            <span class="text-secondary fw-bold">Reference person </span>
            <span class="fw-bold">Pierre claver koko Banywera </span>
          </div>
        </div>
      </div>
    }

    @if (!showDetails) {
      <ng-container>
        <ng-container *ngTemplateOutlet="info"> </ng-container>
      </ng-container>
    }

    @if (showDetails) {
      <ng-container>
        <ng-container *ngTemplateOutlet="details"> </ng-container>
      </ng-container>
    }
    <!-- Info Section -->
    <ng-template #info>
      <div class="row">
        <!-- Left Side -->

        <div class="col-8 d-flex flex-column p-2">
          <!-- Details -->

          <div class="w-100 d-flex position-relative flex-column gap-0 mb-4">
            <div class="w-100 d-flex flex-row px-3 mb-2 align-items-center">
              <span
                class="bg-primary rounded-circle position-absolute redDot"></span>
              <span class="fw-bold">Details</span>
            </div>

            <div class="w-100 d-flex flex-wrap px-3">
              <div class="w-50 d-flex flex-column gap-1 mb-4">
                <span class="fw-bold text-secondary">Username</span>
                <span class="fw-bold">{{
                  organizationDetails?.operator?.username
                }}</span>
              </div>
              <div class="w-50 d-flex flex-column gap-1 mb-4">
                <span class="fw-bold text-secondary">Full name</span>
                <span class="fw-bold">{{
                  organizationDetails?.operator?.employee_client
                    ?.client_full_name ?? '------'
                }}</span>
              </div>
              <div class="w-50 d-flex flex-column gap-1 mb-4">
                <span class="fw-bold text-secondary">Ips Allowed</span>
                @if (
                  !organizationDetails?.operator?.allowed_ips ||
                  organizationDetails?.operator?.allowed_ips?.length === 0
                ) {
                  <span class="fw-bold">---.-.-.-</span>
                }
                @if (
                  organizationDetails?.operator?.allowed_ips &&
                  organizationDetails?.operator?.allowed_ips
                ) {
                  <span class="fw-bold">{{
                    organizationDetails?.operator?.allowed_ips?.[0]
                  }}</span>
                }
              </div>
              <div class="w-50 d-flex flex-column gap-1 mb-4">
                <span class="fw-bold text-secondary">Active</span>
                @if (organizationDetails?.operator?.is_active) {
                  <span class="fw-bold"
                    ><i class="fa-solid fa-circle-check fa-lg check"></i
                  ></span>
                }
                @if (!organizationDetails?.operator?.is_active) {
                  <span class="fw-bold"
                    ><i class="fa-solid fa-circle-xmark fa-lg xmark"></i
                  ></span>
                }
              </div>
              <div class="w-50 d-flex flex-column gap-1 mb-4">
                <span class="fw-bold text-secondary">Work Phone</span>
                <span class="fw-bold">72 000 111</span>
              </div>
              <div class="w-50 d-flex flex-column gap-1 mb-4">
                <span class="fw-bold text-secondary">Email</span>
                <span class="fw-bold">{{
                  organizationDetails?.operator?.employee_client?.client_email
                }}</span>
              </div>
            </div>
          </div>

          <!-- Position Details -->
          <div class="w-100 d-flex position-relative flex-column gap-0">
            <div class="w-100 d-flex flex-row px-3 mb-2 align-items-center">
              <span
                class="bg-primary rounded-circle position-absolute redDot"></span>
              <span class="fw-bold">Position Details</span>
            </div>

            <div class="w-100 d-flex flex-wrap px-3">
              <div class="w-50 d-flex flex-column gap-1 mb-4">
                <span class="fw-bold text-secondary">Departement</span>
                <span class="fw-bold">Administration</span>
              </div>
              <div class="w-50 d-flex flex-column gap-1 mb-4">
                <span class="fw-bold text-secondary">Manager</span>
                <span class="fw-bold">{{ 'info@test.com' }}</span>
              </div>
              <div class="w-50 d-flex flex-column gap-1 mb-4">
                <span class="fw-bold text-secondary">Teller</span>
                @if (organizationDetails?.is_teller) {
                  <span class="fw-bold"
                    ><i class="fa-solid fa-circle-check fa-lg check"></i
                  ></span>
                }
                @if (!organizationDetails?.is_teller) {
                  <span class="fw-bold"
                    ><i class="fa-solid fa-circle-xmark fa-lg xmark"></i
                  ></span>
                }
              </div>
              <div class="w-50 d-flex flex-column gap-1">
                <span class="fw-bold text-secondary">Treasurer</span>
                @if (organizationDetails?.is_treasurer) {
                  <span class="fw-bold"
                    ><i class="fa-solid fa-circle-check fa-lg check"></i
                  ></span>
                }
                @if (!organizationDetails?.is_treasurer) {
                  <span class="fw-bold"
                    ><i class="fa-solid fa-circle-xmark fa-lg xmark"></i
                  ></span>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Right Side -->

        <div class="col-4">
          <!-- Document -->
          <div>
            <div class="w-100 d-flex flex-row gap-2 align-items-center">
              <span class="bg-primary rounded-circle redDot"></span>
              <span class="fw-bold">Document</span>
            </div>
            <div class="mt-2 px-3 pt-3 pb-5 border border-secondary rounded-2">
              <div class="d-flex flex-column">
                <span class="text-secondary fs-medium">CV</span>
                <span href="#" class="fw-bold text-info clickable text-truncate"
                  ><u>cv_bibyento.pdf</u
                  ><i
                    class="fa-solid fa-file-arrow-down ms-3 text-secondary"></i
                ></span>
              </div>

              <div class="d-flex flex-column mt-3">
                <span class="text-secondary fs-medium"
                  >Attestation de residence</span
                >
                <span href="#" class="fw-bold text-info clickable text-truncate"
                  ><u>residence_bibyento.docs</u
                  ><i
                    class="fa-solid fa-file-arrow-down ms-3 text-secondary"></i
                ></span>
              </div>

              <div class="d-flex flex-column mt-3">
                <span class="text-secondary fs-medium">Identite complete</span>
                <span href="#" class="fw-bold text-info clickable text-truncate"
                  ><u>Identinte_complete_bibyento.docs</u
                  ><i
                    class="fa-solid fa-file-arrow-down ms-3 text-secondary"></i
                ></span>
              </div>

              <div class="d-flex flex-column mt-3">
                <span class="text-secondary fs-medium">CNI</span>
                <span href="#" class="fw-bold text-info clickable text-truncate"
                  ><u>CNI_bibyento.docs</u
                  ><i
                    class="fa-solid fa-file-arrow-down ms-3 text-secondary"></i
                ></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Operations Section -->
      <div
        class="w-100 bg-secondary rounded-2 border border-secondary mt-4"
        style="height: 250px">
        <div class="w-100 d-flex flex-row px-3 mt-2 gap-2 align-items-center">
          <span class="bg-primary rounded-circle redDot"></span>
          <span class="fw-bold">Recent Operations</span>
        </div>
      </div>
    </ng-template>

    <ng-template #details>
      <!-- Details -->

      <div class="mt-5 mx-3 h-75">
        <div class="w-nav d-flex flex-row border-bottom">
          <div
            class="px-4 clickable"
            [ngClass]="
              selectedMenu === 'roles'
                ? 'border-3 border-primary border-bottom'
                : ''
            "
            (click)="selectMenu('roles')"
            tabindex="0">
            <span class="fw-bold">Role(s)</span>
          </div>

          <div
            class="px-4 clickable"
            [ngClass]="
              selectedMenu === 'menus'
                ? 'border-3 border-primary border-bottom'
                : ''
            "
            (click)="selectMenu('menus')"
            tabindex="0">
            <span class="fw-bold">Menu(s)</span>
          </div>

          <div class="px-4 clickable">
            <span class="fw-bold">Counter(s)</span>
          </div>
        </div>
        <div class="mt-5 details">
          <div class="d-flex flex-row justify-content-between">
            @if (selectedSection === 'roles') {
              <div
                class="py-1 rounded px-3 border border-2 border-secondary clickable">
                <i class="fa-solid fa-circle-plus"></i>
                <span
                  class="ms-2 fw-bold"
                  (click)="selectSection('assignment')"
                  tabindex="0"
                  >Assign New Roles</span
                >
              </div>
            }

            @if (
              selectedMenu !== 'roles' ||
              (selectedMenu === 'roles' && selectedSection === 'assignment')
            ) {
              <div></div>
            }
            <div class="h-100 d-flex flex-row gap-2">
              <div class="position-relative">
                <input
                  class="form-control"
                  type="search"
                  [formControl]="searchInput" />
                <div
                  class="position-absolute end-0 top-0 pe-2 fa-lg h-100 d-flex align-items-center clickable"
                  (click)="searchRolesOrMenus()"
                  tabindex="0">
                  @if (loadingAllMenus) {
                    <span>
                      <i class="fas fa-spinner fa-pulse text-secondary"></i>
                    </span>
                  }

                  @if (!loadingAllMenus) {
                    <span>
                      <i
                        class="fa-solid fa-magnifying-glass text-secondary"></i>
                    </span>
                  }
                </div>
              </div>
              @if (selectedRole && selectedSection === 'roles') {
                <div
                  class="d-flex align-items-center px-2 rounded bg-primary-2 clickable"
                  (click)="backToRoles()"
                  tabindex="0">
                  <i class="fa-solid fa-arrow-left text-primary fa-lg"></i>
                </div>
              }
            </div>
          </div>
          @if (rolesLoading) {
            <div class="w-100 d-flex justify-content-center mt-3">
              <span class="my-5">
                <i class="fa-solid fa-spin fa-circle-notch fa-2x"></i>
              </span>
            </div>
          }
          @if (!rolesLoading && !selectedRole && selectedSection === 'roles') {
            <div class="my-3 d-flex flex-column gap-3 overflow-y-auto">
              @for (role of roles; track $index) {
                <div
                  class="clickable border d-flex flex-row justify-content-between w-100 p-2 rounded"
                  (click)="selectRole(role)"
                  tabindex="0">
                  <div class="d-flex flex-column justify-content-between gap-2">
                    <span class="fw-bold">{{ role.role_name }}</span>
                    <div class="d-flex align-items-center">
                      <div class="">
                        <span class="fw-bold badge-design bg-secondary py-1">{{
                          role.role_type.title
                        }}</span>
                      </div>

                      <div class="">
                        <span class="text-primary fw-bold badge-design"
                          >Teller</span
                        >
                      </div>
                    </div>

                    <div
                      class="d-flex flex-row align-items-center justify-content-between gap-2 py-1">
                      <span
                        [class]="
                          'fw-bold badge-design py-1 px-2 bg-' +
                          role.access_type.css
                        ">
                        <i
                          [class]="
                            'fa-solid text-secondary fa-' +
                            role.access_type.icon
                          "></i>

                        {{ role.access_type.title }}
                      </span>

                      <i
                        class="fa-solid fa-arrow-up-right-from-square text-primary fa-lg fw-bold"></i>
                    </div>
                  </div>

                  <div class="d-flex flex-column justify-content-between">
                    <div class="d-flex flex-column align-items-center gap-0">
                      <span class="fw-bold">{{
                        role.begins_at | date: 'medium'
                      }}</span>
                      <div class="">
                        <span
                          [class]="
                            'badge-design px-3 bg-' +
                            role.operator_role_state.css
                          "
                          style="max-width: fit-content"
                          >{{ role.operator_role_state.value }}</span
                        >
                      </div>
                      <span class="fw-bold">{{
                        role.ends_at | date: 'medium'
                      }}</span>
                    </div>

                    <div class="align-self-end pt-2">
                      <i class="fa-solid fa-ellipsis fa-2x"></i>
                    </div>
                  </div>
                </div>
              }
            </div>
          }

          <!------------------------------------------------------------ ALL MENUS ------------------------------------------------------------------------->

          @if (selectedSection === 'menus') {
            <div
              class="my-3 d-flex flex-column gap-3 overflow-y-auto align-items-center w-100">
              @if (loadingAllMenus) {
                <span class="my-5">
                  <i class="fa-solid fa-spin fa-circle-notch fa-2x"></i>
                </span>
              }
              @for (menu of allMenus; track $index) {
                <div class="w-100 rounded border row p-2">
                  <div class="d-flex flex-column gap-1 col">
                    <div class="d-flex flex-row gap-2">
                      <span class="text-secondary fw-bold fs-small text-nowrap"
                        >Name :</span
                      >
                      <span class="fw-bold fs-small">{{
                        menu.lookup_title
                      }}</span>
                    </div>
                  </div>

                  <div class="d-flex flex-column gap-1 col">
                    <div class="d-flex flex-row gap-2">
                      <span class="text-secondary fw-bold fs-small text-nowrap"
                        >Group :</span
                      >
                      <span class="fw-bold fs-small">{{
                        menu.menu_group_info?.name
                      }}</span>
                    </div>
                  </div>

                  <div class="d-flex flex-column gap-1 col">
                    <div class="d-flex flex-row gap-2">
                      <span class="text-secondary fw-bold fs-small text-nowrap"
                        >Active :</span
                      >
                      @if (menu.menu_group_info?.active) {
                        <span class="fw-bold"
                          ><i class="fa-solid fa-circle-check check"></i
                        ></span>
                      }

                      @if (!menu.menu_group_info?.active) {
                        <span class="fw-bold"
                          ><i class="fa-solid fa-circle-xmark xmark"></i
                        ></span>
                      }
                    </div>
                  </div>
                  <div class="d-flex flex-row gap-2">
                    <span class="text-secondary fw-bold fs-small text-nowrap"
                      >Url :</span
                    >
                    @if (menu.lookup_subtitle) {
                      <span class="fw-bold fs-small">{{
                        menu.lookup_subtitle
                      }}</span>
                    }
                  </div>
                </div>
              }
            </div>
          }

          <!------------------------------------------------------------------------------ASSIGN NEW ROLES  -------------------------------------------------------------------------------->

          @if (selectedSection === 'assignment' && selectedMenu === 'roles') {
            <div class="mt-4">
              <form
                [formGroup]="newRoleForm"
                class="w-100 mx-auto row justify-content-center align-items-center"
                style="gap: 0.7rem 0">
                <div class="input w-50 px-2">
                  <label
                    for="begins_at"
                    class="form-label fw-bold text-dark"
                    i18n
                    >Begins At <code>*</code></label
                  >
                  <input
                    type="datetime-local"
                    class="form-control px-1"
                    formControlName="begins_at"
                    id="begins_at" />
                </div>
                <div class="input w-50 px-2">
                  <label for="ends_at" class="form-label fw-bold text-dark" i18n
                    >Ends At <code>*</code></label
                  >
                  <input
                    type="datetime-local"
                    class="form-control px-1"
                    id="ends_at"
                    formControlName="ends_at" />
                </div>
                <div class="mt-2 w-100">
                  <app-multi-select
                    url="/hr/access/roles/objects_autocomplete/?search="
                    [defaultDataIds]="rolesId"
                    name="Roles"
                    (selectedItemEvent)="
                      selectedItems($event)
                    "></app-multi-select>
                </div>
              </form>
              <div class="mx-auto text-center mt-1 mb-3">
                <span
                  tabindex="0"
                  *ngIf="!assignLoading"
                  role="button"
                  class="me-4 text-dark"
                  (click)="selectSection('roles')"
                  tabindex="0"
                  i18n
                  >Cancel</span
                >
                <button
                  (click)="assignNewRole()"
                  type="submit"
                  class="btn bg-primary text-light px-3"
                  [disabled]="
                    !newRoleForm.valid ||
                    !selectedRolesToAssign ||
                    selectedRolesToAssign.length === 0 ||
                    assignLoading
                  ">
                  @if (!assignLoading) {
                    <b i18n> Add</b>
                  }
                  @if (assignLoading) {
                    <span>
                      <i
                        class="fa-solid fa-spin fa-circle-notch fs-5 text-light px-2"></i>
                    </span>
                  }
                </button>
              </div>
            </div>
          }

          <!------------------------------------------------------------ SELECTED ROLE & MENUS ------------------------------------------------------------------------->

          @if (
            selectedRole &&
            selectedSection === 'roles' &&
            selectedMenu === 'roles'
          ) {
            <div
              class="mt-3 border border-3 border-primary d-flex flex-row justify-content-between w-100 p-2 rounded">
              <div class="d-flex flex-column justify-content-between gap-2">
                <span class="fw-bold">{{ selectedRole.role_name }}</span>
                <div class="d-flex align-items-center">
                  <div class="">
                    <span class="fw-bold badge-design bg-secondary py-1">{{
                      selectedRole.role_type.title
                    }}</span>
                  </div>

                  <div class="">
                    <span class="text-primary fw-bold badge-design"
                      >Teller</span
                    >
                  </div>
                </div>

                <div
                  class="d-flex flex-row align-items-center justify-content-between gap-2 py-1">
                  <span
                    [class]="
                      'fw-bold badge-design py-1 px-2 bg-' +
                      selectedRole.access_type.css
                    ">
                    <i
                      [class]="
                        'fa-solid text-secondary fa-' +
                        selectedRole.access_type.icon
                      "></i>

                    {{ selectedRole.access_type.title }}
                  </span>

                  <i
                    class="fa-solid fa-arrow-up-right-from-square text-primary fa-lg fw-bold"></i>
                </div>
              </div>

              <div class="d-flex flex-column justify-content-between">
                <div class="d-flex flex-column align-items-center gap-0">
                  <span class="fw-bold">{{
                    selectedRole.begins_at | date: 'medium'
                  }}</span>
                  <div class="">
                    <span
                      [class]="
                        'badge-design px-3 bg-' +
                        selectedRole.operator_role_state.css
                      "
                      style="max-width: fit-content"
                      >{{ selectedRole.operator_role_state.value }}</span
                    >
                  </div>
                  <span class="fw-bold">{{
                    selectedRole.ends_at | date: 'medium'
                  }}</span>
                </div>

                <div class="align-self-end pt-2">
                  <i class="fa-solid fa-ellipsis fa-2x"></i>
                </div>
              </div>
            </div>

            <div class="d-flex flex-column w-100 my-4 gap-3 align-items-center">
              <div class="d-flex flex-row gap-2 align-items-center w-100">
                <i class="fa-solid fa-play text-primary fs-l-medium"></i>
                <span class="fs-l-medium fw-bold"> Menu </span>
              </div>

              @if (loadingRoleMenus) {
                <div
                  class="w-100 d-flex align-items-center justify-content-center">
                  <i
                    class="fa-solid fa-spin fa-circle-notch fa-lg text-dark"></i>
                </div>
              }

              @if (!loadingRoleMenus) {
                @for (menu of roleMenus; track $index) {
                  <div class="w-100 rounded border row p-2">
                    <div class="d-flex flex-column gap-1 col">
                      <div class="d-flex flex-row gap-2">
                        <span
                          class="text-secondary fw-bold fs-small text-nowrap"
                          >Name :</span
                        >
                        <span class="fw-bold fs-small">{{
                          menu.menu.name
                        }}</span>
                      </div>
                    </div>

                    <div class="d-flex flex-column gap-1 col">
                      <div class="d-flex flex-row gap-2">
                        <span
                          class="text-secondary fw-bold fs-small text-nowrap"
                          >Group :</span
                        >
                        <span class="fw-bold fs-small">{{
                          menu.menu.menu_group_info?.name
                        }}</span>
                      </div>
                    </div>

                    <div class="d-flex flex-column gap-1 col">
                      <div class="d-flex flex-row gap-2">
                        <span
                          class="text-secondary fw-bold fs-small text-nowrap"
                          >Active :</span
                        >
                        @if (menu.menu.active) {
                          <span class="fw-bold"
                            ><i class="fa-solid fa-circle-check check"></i
                          ></span>
                        }

                        @if (!menu.menu.active) {
                          <span class="fw-bold"
                            ><i class="fa-solid fa-circle-xmark xmark"></i
                          ></span>
                        }
                      </div>
                    </div>
                    <div class="d-flex flex-row gap-2">
                      <span class="text-secondary fw-bold fs-small text-nowrap"
                        >Url :</span
                      >
                      @if (menu.menu.component_url) {
                        <span class="fw-bold fs-small">{{
                          menu.menu.component_url
                        }}</span>
                      }
                    </div>
                  </div>
                }
              }
            </div>

            <!-- <div class="d-flex flex-column w-100 mt-4 gap-3 align-items-center">
              <div class="d-flex flex-row gap-2 align-items-center w-100">
                <i class="fa-solid fa-play text-primary fs-l-medium"></i>
                <span class="fs-l-medium fw-bold"> Menu </span>
              </div>

              <div class="w-100 rounded border row p-2">
                <div class="d-flex flex-column gap-1 col">
                  <div class="d-flex flex-row gap-2">
                    <span class="text-secondary fw-bold fs-small">Name :</span>
                    <span class="fw-bold fs-small">Group</span>
                  </div>
                  <div class="d-flex flex-row gap-2">
                    <span class="text-secondary fw-bold fs-small">Url :</span>
                  </div>
                </div>

                <div class="d-flex flex-column gap-1 col">
                  <div class="d-flex flex-row gap-2">
                    <span class="text-secondary fw-bold fs-small">Group :</span>
                    <span class="fw-bold fs-small">Group</span>
                  </div>
                </div>

                <div class="d-flex flex-column gap-1 col">
                  <div class="d-flex flex-row gap-2">
                    <span class="text-secondary fw-bold fs-small"
                      >Active :</span
                    >
                    <span class="fw-bold"
                      ><i class="fa-solid fa-circle-xmark check"></i
                    ></span>
                  </div>
                </div>
              </div>
            </div> -->
          }
        </div>
      </div>
    </ng-template>
  }
</div>
