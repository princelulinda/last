<div *ngIf="!selectedMenu">
  <div class="d-grid">
    <div class="mb-2 w-100 d-flex justify-content-between align-items-center">
      <div class="w-100 d-grid">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <span class="text-xl" i18n>Manage Products</span>
          <div
            routerLink="/m/market/mymarket"
            role="button"
            class="d-flex align-items-center">
            <span>
              <i class="fa fa-arrow-left fs-5"></i>
            </span>
            <b class="fs-5 ms-1" i18n> Back</b>
          </div>
        </div>
        <div class="d-flex justify-content-between aligni-items-center">
          <div class="d-flex align-items-center">
            <div class="me-lg-5 me-md-4 me-1 d-flex">
              <input
                type="text"
                class="form-control round-3 input lookup text-dark pe-5"
                placeholder="Search product..."
                style="border: none"
                aria-describedby="validationTooltipUsernamePrepend"
                required
                [formControl]="search"
                (keydown.enter)="searchProducts(search.value)"
                (input)="searchProducts(search.value)" />

              <div
                role="button"
                (click)="searchProducts(search.value)"
                tabindex="0">
                <span
                  style="height: 38px"
                  class="bg-dark pt-1 px-2 d-inline-block round-3 d-flex justify-content-center align-items-center text-white">
                  <span *ngIf="!isLoading">
                    <i class="fa-solid fa-search px-1 fs-5"></i>
                  </span>
                  <span *ngIf="isLoading">
                    <i
                      class="fa-solid fa-pulse px-1 fa-circle-notch text-white"></i>
                  </span>
                </span>
              </div>
            </div>
            <div
              title="Not yet available"
              role="button"
              class="d-flex align-items-center round-30 px-4 py-2">
              <span class="text-md-sm" i18n>Filter</span>
              <span class="d-flex ms-1">
                <i class="fa fa-bars-staggered"></i>
              </span>
            </div>
          </div>
          <button
            [disabled]="!products"
            routerLink="/m/market/add-product"
            class="btn mt-sm-2 mt bg-primary t-white">
            <b i18n>Add product</b>
          </button>
        </div>
      </div>
    </div>
    <hr class="w-100 mt-2" />
  </div>
  <div *ngIf="isProductsSearch && search.value">
    <div class="d-flex justify-content-start">
      <span class="my-2 d-flex align-items-center fw-bold border rounded p-1">
        <span class="me-3">{{ search.value }}</span>
        <span
          (click)="getProducts()"
          tabindex="0"
          title="clear search results"
          role="button">
          <i class="fa text-danger fa-xmark"></i>
        </span>
      </span>
    </div>
  </div>

  <div *ngIf="!products">
    <div class="row">
      <div *ngFor="let _ of [1, 2, 3]" class="d-grid mb-3 col-auto">
        <div class="d-grid me-3">
          <span>
            <app-skeleton
              height="130px"
              width="130px"
              classes="sm-radius"></app-skeleton>
          </span>
        </div>
        <div class="d-grid">
          <span class="">
            <app-skeleton
              height="10px"
              width="100px"
              classes="sm-radius"></app-skeleton>
          </span>
          <span class="">
            <app-skeleton
              height="10px"
              width="100px"
              classes="sm-radius"></app-skeleton>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="products && products.length > 0" class="row">
    <div
      class="d-grid mb-3 col-lg-3 col-md-6 col-sm-12"
      *ngFor="let product of products">
      <div
        *ngIf="!isProductsSearch"
        class="d-grid prod-card-w"
        role="button"
        (click)="selectProduct(product)"
        tabindex="0">
        <span
          *ngIf="!product.icon"
          class="text-center prod-card d-flex p-3 rounded justify-content-center align-items-center"
          style="font-size: 60px">
          <i class="fa-solid t-white fa-box-open"></i>
        </span>
        <span
          *ngIf="product.icon"
          class="text-center d-flex p-3 prod-card rounded justify-content-center align-items-center"
          style="font-size: 60px">
          <i class="t-white fa-solid fa-{{ product.icon }}"></i>
        </span>
        <b class="text-md text-card">{{ product.name }}</b>
        <span>{{ product.price | currency: ' ' }}</span>
      </div>
      <div
        *ngIf="isProductsSearch"
        class="d-grid prod-card-w"
        role="button"
        (click)="selectProduct(product)"
        tabindex="0">
        <span
          *ngIf="!product.lookup_icon"
          class="text-center d-flex prod-card p-3 rounded justify-content-center align-items-center"
          style="font-size: 60px">
          <i class="fa-solid t-white fa-box-open"></i>
        </span>
        <span
          *ngIf="product.lookup_icon"
          class="text-center d-flex p-3 rounded prod-card justify-content-center align-items-center"
          style="font-size: 60px">
          <i class="t-white fa-solid fa-{{ product.lookup_icon }}"></i>
        </span>
        <b class="text-md text-card">{{ product.lookup_title }}</b>
        <span>{{ product.lookup_subtitle | currency: ' ' }}</span>
      </div>
    </div>
  </div>
  <div
    *ngIf="products && products.length === 0"
    class="my-4 d-flex align-items-center">
    <b class="text-l me-4 text-secondary" i18n>No products found</b>
  </div>
</div>
<div
  class="w-75"
  *ngIf="
    selectedMenu === 'details' ||
    (selectedMenu === 'configuration' && !toggleMetadata && !toggleMetadataForm)
  ">
  <div class="border sm-radius d-lg-flex" *ngIf="product">
    <div style="width: 10%; border-left: 4px solid #c4c4c4">
      <img
        *ngIf="merchant && !merchant.merchant_logo"
        src="assets/images/userprofile.png"
        class="img-fluid mt-2 ms-2 border rounded-circle mb-2"
        style="width: 60%"
        alt="profile" />
      <img
        *ngIf="merchant && merchant.merchant_logo"
        [src]="merchant.merchant_logo"
        class="img-fluid image mt-2 ms-2 rounded-circle mb-2"
        style="width: 60%"
        alt="merchant-logo" />
    </div>
    <div class="d-block pt-2">
      <span class="text-dark fw-bold text-md">{{
        merchant.merchant_title ?? '---'
      }}</span>
      <br />
      <span class="text-dark text-sm">{{
        merchant.merchant_code ?? '---'
      }}</span>
      <br />
    </div>
  </div>
</div>
<div
  class="w-75"
  *ngIf="selectedMenu === 'details' && !toggleMetadata && !toggleMetadataForm">
  <div class="d-grid mt-3">
    <div class="mb-2 w-100 d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <b class="text-md me-2">Product details</b>
        <span
          [ngClass]="product ? 'clickable' : 'not-clickable'"
          (click)="editProductInfo()"
          tabindex="0"
          title="Edit product information"
          role="button">
          <i class="fa fa-pen"></i>
        </span>
      </div>
      <div
        (click)="goBack()"
        tabindex="0"
        role="button"
        class="d-flex align-items-center">
        <span>
          <i class="fa fa-arrow-left fs-5"></i>
        </span>
        <b class="fs-5 ms-1" i18n> Back</b>
      </div>
    </div>
    <hr class="w-100 mt-2" />
  </div>
  <div *ngIf="!product">
    <div class="w-100 mt-4 d-flex justify-content-center" *ngIf="!product">
      <span class="spinner-border"> </span>
    </div>
  </div>
  <div *ngIf="product" class="row">
    <div class="d-grid mb-3 col-6">
      <b class="text-secondary text-sm" i18n>Name</b>
      <b class="text-md-sm">{{ product.name }}</b>
    </div>
    <div class="d-grid mb-3 col-6">
      <b class="text-secondary text-sm" i18n>Price</b>
      <b class="text-md-sm">{{ product.price | currency: ' ' }}</b>
      <b *ngIf="!product.price">---</b>
    </div>
    <div class="d-grid mb-3 col-6">
      <b class="text-secondary text-sm" i18n>Min payment</b>
      <b class="text-md-sm">{{
        product.minimun_payment_amount | currency: ' '
      }}</b>
    </div>
    <div class="d-grid mb-3 col-6">
      <b class="text-secondary text-sm" i18n>Max payment</b>
      <b class="text-md-sm">{{
        product.maximum_payment_amount | currency: ' '
      }}</b>
    </div>
    <div class="d-grid mb-3 col-6">
      <b class="text-secondary text-sm">Position</b>
      <b *ngIf="product.voucher_type === 'L'" class="text-sm">Landscape</b>
      <b *ngIf="product.voucher_type === 'P'" class="text-sm" i18n>Portrait</b>
    </div>

    <div class="d-grid col-6 mb-3">
      <b class="text-secondary text-sm" i18n>Stockable</b>
      <b class="fs-5">
        <span *ngIf="product.is_stockable">
          <i class="fa fa-check-circle text-success"></i>
        </span>
        <span *ngIf="!product.is_stockable">
          <i class="fa fa-circle-xmark text-danger"></i>
        </span>
      </b>
    </div>
    <div class="d-grid col-6 mb-3">
      <b class="text-secondary text-sm" i18n>Cart</b>
      <b class="fs-5">
        <span *ngIf="product.accepts_cart">
          <i class="fa fa-check-circle text-success"></i>
        </span>
        <span *ngIf="!product.accepts_cart">
          <i class="fa fa-circle-xmark text-danger"></i>
        </span>
      </b>
    </div>
    <div class="d-grid col-6 mb-3">
      <b class="text-secondary text-sm" i18n>Incognito</b>
      <b class="fs-5">
        <span *ngIf="product.incognito_mode">
          <i class="fa fa-check-circle text-success"></i>
        </span>
        <span *ngIf="!product.incognito_mode">
          <i class="fa fa-circle-xmark text-danger"></i>
        </span>
      </b>
    </div>
  </div>
</div>
<div
  *ngIf="
    selectedMenu === 'configuration' && !toggleMetadata && !toggleMetadataForm
  "
  class="mt-3 w-75">
  <div class="d-grid">
    <div class="mb-2 w-100 d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <b class="text-md me-2" i18n>Product Configuration</b>
      </div>
      <div
        (click)="goBack()"
        tabindex="0"
        role="button"
        class="d-flex align-items-center">
        <span>
          <i class="fa fa-arrow-left fs-5"></i>
        </span>
        <b class="fs-5 ms-1" i18n> Back</b>
      </div>
    </div>
    <hr class="w-100 mt-2" />
  </div>

  <div
    [formGroup]="productConfigForm"
    [ngClass]="isLoading ? 'not-clickable' : 'clickable'"
    class="row justify-content-between mx-2">
    <div class="col-lg-5 mb-3">
      <div class="form-floating">
        <input
          type="text"
          id="name"
          class="form-control input border"
          placeholder="Name"
          formControlName="name" />
        <label for="name" i18n>Name</label>
      </div>
    </div>
    <div class="col-lg-5 mb-3">
      <div class="form-floating">
        <input
          type="text"
          id="price"
          class="form-control input border"
          placeholder="Price"
          formControlName="price" />
        <label for="price" i18n>Price</label>
      </div>
    </div>
    <div class="col-lg-5 mb-3">
      <div class="form-floating">
        <input
          type="text"
          id="min_payment"
          class="form-control input border"
          placeholder="Min payment"
          formControlName="min_payment" />
        <label for="min_payment" i18n>Min payment</label>
      </div>
    </div>
    <div class="col-lg-5 mb-3">
      <div class="form-floating">
        <input
          type="text"
          id="max_payment"
          class="form-control input border"
          placeholder="Max payment"
          formControlName="max_payment" />
        <label for="max_payment" i18n>Max payment</label>
      </div>
    </div>
    <div class="col-lg-5 mb-3">
      <select
        formControlName="position"
        [value]="product.voucher_type"
        class="form-select py-3 text-dark"
        aria-label="Default select example">
        <option value="L" selected i18n>Landscape</option>
        <option value="P" i18n>Portrait</option>
      </select>
    </div>
    <div class="col-12 row">
      <div
        class="mt-3 col-lg-3 col-md-6 col-sm-12 d-flex justify-content-between">
        <div class="d-flex w-100 justify-content-start align-items-center mb-3">
          <b class="text-md-sm me-3" i18n>Cart</b>
          <div
            role="button"
            (click)="
              toggleProductSwitchBox(
                'cart',
                productConfigForm.value.cart
                  ? 'not_accepts_cart'
                  : 'accepts_cart'
              )
            "
            tabindex="0"
            class="switch d-flex align-items-center px-1"
            [ngClass]="
              productConfigForm.value.cart
                ? 'justify-content-end text-primary'
                : 'justify-content-start t-white'
            ">
            <span class="fa fa-circle"></span>
          </div>
        </div>
      </div>
      <div
        class="mt-3 col-lg-3 col-md-6 col-sm-12 d-flex justify-content-between">
        <div class="d-flex w-100 justify-content-start align-items-center mb-3">
          <b class="text-md-sm me-3" i18n>Stockable</b>
          <div
            role="button"
            (click)="
              toggleProductSwitchBox(
                'stockable',
                productConfigForm.value.stockable
                  ? 'not_stockable'
                  : 'stockable'
              )
            "
            tabindex="0"
            class="switch d-flex align-items-center px-1"
            [ngClass]="{
              'justify-content-end text-primary':
                productConfigForm.value.stockable,
              'justify-content-start t-white':
                !productConfigForm.value.stockable,
            }">
            <span class="fa fa-circle"></span>
          </div>
        </div>
      </div>
      <div
        class="mt-3 col-lg-3 col-md-6 col-sm-12 d-flex justify-content-between">
        <div class="d-flex w-100 justify-content-start align-items-center mb-3">
          <b class="text-md-sm me-3" i18n>Incognito</b>
          <div
            role="button"
            (click)="
              toggleProductSwitchBox(
                'incognito',
                productConfigForm.value.incognito
                  ? 'not_incognito'
                  : 'incognito'
              )
            "
            tabindex="0"
            class="switch d-flex align-items-center px-1"
            [ngClass]="{
              'justify-content-end text-primary':
                productConfigForm.value.incognito,
              'justify-content-start t-white':
                !productConfigForm.value.incognito,
            }">
            <span class="fa fa-circle"></span>
          </div>
        </div>
      </div>
    </div>
    <hr class="w-100 mt-2" />
    <div
      *ngIf="selectedFields.length > 0"
      class="row justify-content-between pe-0 ps-4">
      <div class="col-lg-5 pe-0 ps-0 mb-3" *ngFor="let field of selectedFields">
        <div class="form-control border d-flex pt-2">
          <span><i class="fa-solid fa-star text-primary"></i></span>
          <span class="ms-2">
            {{ field.name }}
          </span>
        </div>
      </div>
    </div>

    <div class="col-12 row mt-2">
      <b
        role="button"
        (click)="toggleMetadataList()"
        tabindex="0"
        class="text-primary"
        style="text-decoration: underline">
        Add option</b
      >
    </div>
    <div class="col-12 d-flex justify-content-center align-items-center mt-3">
      <b (click)="goBack()" tabindex="0" role="button">Cancel</b>
      <button
        class="bg-primary btn text-white px-3 ms-4"
        (click)="verifyPinProductUpdate()"
        tabindex="0"
        [disabled]="!productConfigForm.dirty && selectedFields.length === 0">
        <b *ngIf="!isLoading" i18n>Save</b>
        <span *ngIf="isLoading">
          <i class="fa-solid fa-spin fa-circle-notch fs-4"></i>
        </span>
      </button>
    </div>
  </div>
</div>
<div *ngIf="toggleMetadata" class="w-75 p-2 border sm-radius">
  <div class="col-12 mb-2 mt-3">
    <span class="fw-bold text-dark text-md ms-3" i18n> Other option </span>
    <div class="m-3 border row justify-content-center">
      <div class="col-6 pe-0 ps-0">
        <div class="col d-flex pt-3 ps-2 pe-2 level-2">
          <div class="col me-2 ms-3">
            <input
              type="search"
              placeholder="Name"
              class="form-control input text-dark"
              [disabled]="loadingData"
              aria-label="search"
              aria-describedby="basic-addon1"
              [formControl]="searchMetadata" />
            <!-- <span
              role="button"
              class="position-relative"
              style="top: -45%; right: -85%"
              (click)="getMetadata()"
              tabindex="0">
              <span *ngIf="!loadingData"
                ><i
                  class="fa-solid fa-text-dark fa-magnifying-glass opacity-50 text-md"></i
              ></span>
              <span *ngIf="loadingData">
                <i class="fas fa-spinner fa-pulse"></i>
              </span>
            </span> -->
          </div>

          <button
            class="bg-primary btn text-white px-3 ms-2"
            (click)="toggleMetadata = false; addNewField()"
            tabindex="0">
            <b i18n>New</b>
          </button>
        </div>
        <div class="level-1 mt-2 p-2">
          <div
            class="d-flex flex-column align-items-center mt-5 empty-state-icon"
            *ngIf="!loadingData && metadata.length === 0">
            <span class="" style="font-size: 50px; opacity: 0.5">
              <i class="fa-solid fa-face-meh"></i>
            </span>
            <b class="fs-4" style="opacity: 0.5" i18n> No Metadata Found </b>
          </div>
          <div
            *ngIf="loadingData && !metadata"
            class="row justify-content-center align-items-center"
            style="height: 20vh">
            <i class="fa-solid text-dark fa-spin fa-circle-notch"></i>
          </div>
          <section class="d-flex flex-column" *ngIf="!loadingData && metadata">
            <div
              *ngFor="let meta of metadata.objects; let i = index"
              class="row ps-2 sm-radius d-flex justify-content-between flex-grow-1">
              <div
                class="col p-2 d-flex align-items-center"
                [ngClass]="{ 'bg-danger': isHover[i] }"
                (mouseenter)="isHover[i] = true"
                (mouseleave)="isHover[i] = false"
                i18n>
                <span class="text-dark">{{ meta.name ?? '---' }}</span>
                <span
                  role="button"
                  (click)="toggleFieldSelection(meta.id, meta.name)"
                  tabindex="0"
                  class="text-primary ms-auto fw-bold">
                  {{ isFieldSelected(meta.name) ? 'Remove' : 'Add' }}
                  <span *ngIf="isFieldSelected(meta.name)"
                    ><i class="fa-solid fa-minus"></i
                  ></span>
                  <span *ngIf="!isFieldSelected(meta.name)"
                    ><i class="fa-solid fa-plus"></i
                  ></span>
                </span>
              </div>
            </div>

            <!-- pagination button -->
            <div
              class="mt-4 d-flex align-items-center justify-content-center text-light">
              <button
                title="Previous"
                (click)="doListMove('prev')"
                [disabled]="currentPage === 0"
                class="border-0 me-2 btn d-inline-flex align-items-center rounded p-2 fs-4 text-primary">
                <i class="fa-solid fa-play fa-rotate-180"></i>
              </button>
              <button
                title="Next"
                (click)="doListMove('next')"
                *ngIf="pagination.filters.limit"
                [disabled]="
                  count < (currentPage + 1) * pagination.filters.limit
                "
                class="border-0 ms-2 btn fs-4 d-inline-flex align-items-center rounded p-2 text-primary">
                <i class="fa-solid fa-play"></i>
              </button>
            </div>
          </section>
        </div>
      </div>

      <div class="col-6 bordered p-3 level-1">
        <span class="text-dark" i18n>Selected</span>
        <div *ngIf="selectedFields.length === 0" class="pt-3 d-flex ps-2 pe-4">
          <span class="text-secondary">No fields selected</span>
        </div>
        <div
          *ngFor="let field of selectedFields; let i = index"
          class="pt-3 d-flex ps-2 pe-4">
          <span><i class="fa-circle fa-solid text-xsm text-primary"></i></span>
          <span class="ms-2">{{ field.name }}</span>
          <span
            class="ms-auto text-primary"
            role="button"
            (click)="toggleFieldSelection(field.id, field.name)"
            tabindex="0">
            <i class="fa-solid fa-minus text-sm sm-radius"></i>
          </span>
        </div>
      </div>
    </div>
    <div class="col-12 d-flex justify-content-center align-items-center mt-3">
      <b (click)="toggleMetadata = false" tabindex="0" role="button">Cancel</b>
      <button
        class="bg-primary btn text-white px-3 ms-4"
        (click)="toggleMetadata = false"
        tabindex="0">
        <b i18n>Save</b>
      </button>
    </div>
  </div>
</div>
<div class="p-2 border w-75" *ngIf="toggleMetadataForm">
  <h4 class="ms-4 ps-2 text-dark" i18n>New field</h4>
  <!-- <app-metadata-form
        (refreshUpdates)="seeUpdates($event)"
    ></app-metadata-form> -->
</div>
